@model IEnumerable<IkinciElSatis.Models.Category>

@{
    ViewData["Title"] = "Kategoriler";
}

<style>
    /* ==============================
           AĞAÇ YAPISI STİLLERİ (CSS)
           ========================== */

    .tree-list {
        list-style-type: none;
        padding-left: 20px;
        margin: 0;
    }

    .nested {
        display: none;
        padding-left: 15px;
        border-left: 1px solid #e9ecef;
        margin-left: 9px;
    }

    .active {
        display: block;
        animation: fadeIn 0.3s;
    }

    .tree-item-container {
        display: flex;
        align-items: center;
        padding: 6px 0;
        transition: background-color 0.2s;
        border-radius: 4px;
    }

        .tree-item-container:hover {
            background-color: #f8f9fa;
        }

    .caret-container {
        cursor: pointer;
        user-select: none;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s;
        margin-right: 5px;
    }

        .caret-container:hover {
            background-color: #e2e6ea;
        }

    .caret-icon {
        transition: transform 0.2s ease;
        font-size: 12px;
        color: #6c757d;
    }

    .caret-down {
        transform: rotate(90deg);
        color: #0d6efd;
    }

    .category-link {
        text-decoration: none;
        color: #343a40;
        font-weight: 500;
        font-size: 1.05rem;
        flex-grow: 1;
    }

        .category-link:hover {
            color: #0d6efd;
        }

    .product-count {
        font-size: 0.75rem;
        background-color: #e9ecef;
        color: #6c757d;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 8px;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="text-center mb-4">
                <h2 class="fw-bold display-6 text-primary">
                    <i class="bi bi-diagram-3-fill"></i> Kategori Ağacı
                </h2>
                <p class="text-muted">Detaylı alt kategorileri görmek için oklara tıklayın.</p>
            </div>

            <div class="card shadow border-0">
                <div class="card-body p-4">
                    <ul class="tree-list ps-0">
                        @foreach (var category in Model)
                        {
                            await RenderCategoryTree(category);
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


@{
    async Task RenderCategoryTree(IkinciElSatis.Models.Category category)
    {
        var hasSubCategories = category.SubCategories != null && category.SubCategories.Any();
        var productCount = category.Products?.Count ?? 0;

        <li>
            <div class="tree-item-container">
                @if (hasSubCategories)
                {
                    <span class="caret-container" onclick="toggleTree(this)" title="Genişlet/Daralt">
                        <i class="bi bi-chevron-right caret-icon"></i>
                    </span>
                }
                else
                {
                    <span style="width: 35px; display:inline-block;"></span>
                }

                <a asp-controller="Product" asp-action="Index" asp-route-categoryId="@category.Id" class="category-link">
                    @category.Name
                </a>

                @if (productCount > 0)
                {
                    <span class="product-count" title="Bu kategorideki ürün sayısı">@productCount</span>
                }
            </div>

            @if (hasSubCategories)
            {
                <ul class="nested tree-list">
                    @foreach (var subCategory in category.SubCategories)
                    {
                        await RenderCategoryTree(subCategory);
                    }
                </ul>
            }
        </li>
    }
}

<script>
    function toggleTree(element) {
        var icon = element.querySelector(".caret-icon");
        icon.classList.toggle("caret-down");

        var parentLi = element.closest("li");
        var nestedList = parentLi.querySelector(".nested");

        if (nestedList) {
            nestedList.classList.toggle("active");
        }
    }
</script>